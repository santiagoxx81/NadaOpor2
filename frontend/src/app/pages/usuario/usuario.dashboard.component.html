<!-- Header Component -->
<app-header 
  currentPage="Meu Portal"
  userName="UsuÃ¡rio"
  userRole="CIDADÃƒO">
</app-header>

<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div>
      <h1 class="dashboard-title">Meu Portal</h1>
      <p class="dashboard-subtitle">Acompanhe suas solicitaÃ§Ãµes e status</p>
    </div>
    <div class="flex gap-4">
      <button type="button" class="btn btn-primary" (click)="abrirFormAE = !abrirFormAE">
        <span>ğŸ“‹</span>
        Novo Nada Opor
      </button>
      <button type="button" class="btn btn-secondary" (click)="abrirFormPL = !abrirFormPL">
        <span>ğŸ¤</span>
        Nova Palestra
      </button>
    </div>
  </header>

  <!-- Alertas -->
  <div *ngIf="msg" class="alert alert-success">{{ msg }}</div>
  <div *ngIf="erro" class="alert alert-error">{{ erro }}</div>

  <!-- MÃ©tricas Cards -->
  <section class="grid grid-cols-4 mb-8">
    <div class="card">
      <div class="card-header">
        <div class="card-icon">ğŸ“„</div>
        <div class="card-content">
          <h3>Minhas AutorizaÃ§Ãµes</h3>
          <div class="card-value">{{ meusAE.length || 0 }}</div>
          <p class="card-description">Total de solicitaÃ§Ãµes</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon">ğŸ¤</div>
        <div class="card-content">
          <h3>Minhas Palestras</h3>
          <div class="card-value">{{ minhasPL.length || 0 }}</div>
          <p class="card-description">Total de solicitaÃ§Ãµes</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon">â³</div>
        <div class="card-content">
          <h3>Em AnÃ¡lise</h3>
          <div class="card-value">{{ getEmAnaliseCount() }}</div>
          <p class="card-description">Aguardando resposta</p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <div class="card-icon">âœ…</div>
        <div class="card-content">
          <h3>Aprovadas</h3>
          <div class="card-value">{{ getAprovadasCount() }}</div>
          <p class="card-description">SolicitaÃ§Ãµes aprovadas</p>
        </div>
      </div>
    </div>
  </section>

  <!-- FormulÃ¡rio: Novo Nada Opor -->
  <section *ngIf="abrirFormAE" class="card mb-8">
    <h3 class="mb-4">Novo Nada Opor</h3>
    <form [formGroup]="formAE" (ngSubmit)="criarAE()" class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">TÃ­tulo</label>
        <input type="text" class="form-input" formControlName="titulo" placeholder="Nome do evento">
      </div>
      
      <div class="form-group">
        <label class="form-label">Tipo de evento</label>
        <input type="text" class="form-input" formControlName="tipo_evento" placeholder="Ex: feira, show, congresso">
      </div>
      
      <div class="form-group" style="grid-column: 1/-1;">
        <label class="form-label">DescriÃ§Ã£o</label>
        <textarea class="form-textarea" formControlName="descricao" placeholder="Descreva o evento"></textarea>
      </div>
      
      <div class="form-group">
        <label class="form-label">EndereÃ§o</label>
        <input type="text" class="form-input" formControlName="endereco" placeholder="EndereÃ§o completo">
      </div>
      
      <div class="form-group">
        <label class="form-label">Bairro</label>
        <input type="text" class="form-input" formControlName="bairro" placeholder="Nome do bairro">
      </div>
      
      <div class="form-group">
        <label class="form-label">Cidade</label>
        <input type="text" class="form-input" formControlName="cidade" placeholder="Nome da cidade">
      </div>
      
      <div class="form-group">
        <label class="form-label">UF</label>
        <input type="text" class="form-input" formControlName="estado" maxlength="2" placeholder="RJ">
      </div>
      
      <div class="form-group">
        <label class="form-label">CEP</label>
        <input type="text" class="form-input" formControlName="cep" placeholder="00000-000">
      </div>
      
      <div class="form-group">
        <label class="form-label">Data de InÃ­cio</label>
        <input type="datetime-local" class="form-input" formControlName="data_inicio">
      </div>
      
      <div class="form-group">
        <label class="form-label">Data de Fim</label>
        <input type="datetime-local" class="form-input" formControlName="data_fim">
      </div>
      
      <div class="form-group">
        <label class="form-label">PÃºblico estimado</label>
        <input type="number" class="form-input" formControlName="publico_estimado" min="0" placeholder="NÃºmero de pessoas">
      </div>
      
      <div class="form-group" style="grid-column: 1/-1;">
        <label class="form-label">ObservaÃ§Ãµes</label>
        <textarea class="form-textarea" formControlName="observacoes" placeholder="ObservaÃ§Ãµes adicionais"></textarea>
      </div>
      
      <div style="grid-column: 1/-1;">
        <button type="submit" class="btn btn-primary" [disabled]="formAE.invalid">
          <span>ğŸ“¤</span>
          Enviar SolicitaÃ§Ã£o
        </button>
      </div>
    </form>
    
    <details class="mt-6">
      <summary class="font-semibold text-primary cursor-pointer">ğŸ“… Prazos para entrada do pedido</summary>
      <ul class="mt-2 ml-4">
        <li>Pequeno porte (atÃ© 2.000 pessoas): <strong>40 dias</strong> de antecedÃªncia</li>
        <li>MÃ©dio porte (2.001 a 20.000 pessoas): <strong>50 dias</strong> de antecedÃªncia</li>
        <li>Grande porte (acima de 20.001 pessoas): <strong>70 dias</strong> (verificar peculiaridades)</li>
      </ul>
    </details>
  </section>

  <!-- FormulÃ¡rio: Nova Palestra -->
  <section *ngIf="abrirFormPL" class="card mb-8">
    <h3 class="mb-4">Novo pedido de Palestra/Representante</h3>
    <form [formGroup]="formPL" (ngSubmit)="criarPL()" class="grid grid-cols-2 gap-4">
      <div class="form-group">
        <label class="form-label">OrganizaÃ§Ã£o</label>
        <input type="text" class="form-input" formControlName="organizacao" placeholder="Nome da organizaÃ§Ã£o">
      </div>
      
      <div class="form-group">
        <label class="form-label">Temas</label>
        <input type="text" class="form-input" formControlName="temas" placeholder="ex.: trÃ¢nsito, violÃªncia domÃ©stica">
      </div>
      
      <div class="form-group">
        <label class="form-label">EndereÃ§o</label>
        <input type="text" class="form-input" formControlName="endereco" placeholder="EndereÃ§o completo">
      </div>
      
      <div class="form-group">
        <label class="form-label">Bairro</label>
        <input type="text" class="form-input" formControlName="bairro" placeholder="Nome do bairro">
      </div>
      
      <div class="form-group">
        <label class="form-label">Cidade</label>
        <input type="text" class="form-input" formControlName="cidade" placeholder="Nome da cidade">
      </div>
      
      <div class="form-group">
        <label class="form-label">UF</label>
        <input type="text" class="form-input" formControlName="estado" maxlength="2" placeholder="RJ">
      </div>
      
      <div class="form-group">
        <label class="form-label">CEP</label>
        <input type="text" class="form-input" formControlName="cep" placeholder="00000-000">
      </div>
      
      <div class="form-group">
        <label class="form-label">PÃºblico-alvo</label>
        <input type="text" class="form-input" formControlName="publico_alvo" placeholder="Ex: colaboradores, estudantes">
      </div>
      
      <div class="form-group">
        <label class="form-label">Quantidade de pessoas</label>
        <input type="number" class="form-input" formControlName="qtd_pessoas" min="0" placeholder="NÃºmero de pessoas">
      </div>
      
      <div class="form-group">
        <label class="form-label">Data sugerida</label>
        <input type="datetime-local" class="form-input" formControlName="data_sugerida">
      </div>
      
      <div class="form-group" style="grid-column: 1/-1;">
        <label class="form-label">ObservaÃ§Ãµes</label>
        <textarea class="form-textarea" formControlName="observacoes" placeholder="ObservaÃ§Ãµes adicionais"></textarea>
      </div>
      
      <div style="grid-column: 1/-1;">
        <button type="submit" class="btn btn-primary" [disabled]="formPL.invalid">
          <span>ğŸ“¤</span>
          Enviar SolicitaÃ§Ã£o
        </button>
      </div>
    </form>
  </section>

  <!-- NavegaÃ§Ã£o por Abas -->
  <nav class="flex gap-2 mb-6">
    <button 
      class="btn" 
      [class.btn-primary]="tab==='AE'"
      [class.btn-secondary]="tab!=='AE'"
      (click)="tab='AE'">
      ğŸ“‹ Minhas AutorizaÃ§Ãµes
    </button>
    <button 
      class="btn" 
      [class.btn-primary]="tab==='PL'"
      [class.btn-secondary]="tab!=='PL'"
      (click)="tab='PL'">
      ğŸ¤ Minhas Palestras
    </button>
  </nav>

  <!-- Lista: Nada Opor -->
  <section *ngIf="tab==='AE'">
    <div *ngIf="carregandoLista" class="text-center p-8">
      <div class="loading mb-2"></div>
      <p class="text-muted">Carregando suas solicitaÃ§Ãµes...</p>
    </div>
    
    <div *ngIf="erroLista" class="alert alert-error">{{ erroLista }}</div>

    <div *ngIf="!carregandoLista && meusAE?.length" class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Protocolo</th>
            <th>TÃ­tulo</th>
            <th>Cidade/UF</th>
            <th>Status</th>
            <th>Criado</th>
            <th>AÃ§Ãµes</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let it of meusAE">
            <tr>
              <td><strong>{{ it.protocolo }}</strong></td>
              <td>{{ it.titulo }}</td>
              <td>{{ it.cidade }} / {{ it.estado }}</td>
              <td>
                <span class="badge badge-{{ it.status.toLowerCase().replace('_', '-') }}">
                  {{ it.status }}
                </span>
                <div *ngIf="it.status === 'PENDENTE'" class="text-warning font-medium mt-1">
                  âš ï¸ PendÃªncia
                </div>
              </td>
              <td>{{ it.criado_em | date:'short' }}</td>
              <td>
                <button type="button" class="btn btn-sm btn-secondary" (click)="abrirDetalheAE(it.protocolo)">
                  {{ protocoloAberto===it.protocolo ? 'ğŸ‘ï¸ Fechar' : 'ğŸ‘ï¸ Detalhes' }}
                </button>
              </td>
            </tr>

            <!-- Detalhes Expandidos -->
            <tr *ngIf="protocoloAberto===it.protocolo">
              <td colspan="6" style="background: var(--gray-50);">
                <div *ngIf="!detalheAE" class="text-center p-4">
                  <div class="loading mb-2"></div>
                  <p class="text-muted">Carregando detalhes...</p>
                </div>
                
                <div *ngIf="detalheAE" class="p-4">
                  <div class="grid grid-cols-2 gap-4 mb-6">
                    <div><strong>TÃ­tulo:</strong> {{ detalheAE?.titulo }}</div>
                    <div><strong>Tipo:</strong> {{ detalheAE?.tipo_evento || 'â€”' }}</div>
                    <div><strong>Cidade/UF:</strong> {{ detalheAE?.cidade }} / {{ detalheAE?.estado }}</div>
                    <div><strong>CEP:</strong> {{ detalheAE?.cep || 'â€”' }}</div>
                    <div><strong>InÃ­cio:</strong> {{ detalheAE?.data_inicio | date:'short' }}</div>
                    <div><strong>Fim:</strong> {{ detalheAE?.data_fim | date:'short' }}</div>
                    <div><strong>PÃºblico estimado:</strong> {{ detalheAE?.publico_estimado || 'â€”' }}</div>
                    <div><strong>Status:</strong> 
                      <span class="badge badge-{{ detalheAE?.status.toLowerCase().replace('_', '-') }}">
                        {{ detalheAE?.status }}
                      </span>
                    </div>
                    <div style="grid-column: 1/-1;"><strong>EndereÃ§o:</strong> {{ detalheAE?.endereco }}, {{ detalheAE?.bairro }}</div>
                    <div style="grid-column: 1/-1;"><strong>DescriÃ§Ã£o:</strong><br>{{ detalheAE?.descricao || 'â€”' }}</div>
                    <div style="grid-column: 1/-1;"><strong>ObservaÃ§Ãµes:</strong><br>{{ detalheAE?.observacoes || 'â€”' }}</div>
                    <div *ngIf="detalheAE?.status === 'PENDENTE'" style="grid-column: 1/-1;" class="alert alert-warning">
                      <strong>PendÃªncia:</strong><br>{{ detalheAE?.pendencia_obs || 'â€”' }}
                    </div>
                  </div>

                  <!-- SeÃ§Ã£o de Anexos -->
                  <div class="mt-6">
                    <h4 class="mb-4">ğŸ“ Anexos</h4>
                    <p class="text-muted mb-4">
                      Formatos: PDF, JPG, PNG. MÃ¡ximo: 10 MB por arquivo.
                    </p>

                    <!-- Upload de Anexos -->
                    <div *ngIf="podeAnexar" class="grid grid-cols-2 gap-6 mb-6">
                      <div>
                        <h5 class="font-semibold mb-3">ğŸ“‹ ObrigatÃ³rios</h5>
                        <div *ngFor="let d of tipoDocsObrig" class="card mb-3">
                          <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">{{ d.label }}</span>
                            <span *ngIf="uploading[d.key]" class="loading"></span>
                          </div>
                          <div class="flex gap-2 items-center">
                            <input type="file" (change)="onEscolherArquivo(d.key, $event)" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            <button type="button" class="btn btn-sm btn-primary" (click)="enviarArquivo(d.key)" [disabled]="!arquivosSelecionados[d.key]">
                              ğŸ“¤ Anexar
                            </button>
                          </div>
                        </div>
                      </div>
                      
                      <div>
                        <h5 class="font-semibold mb-3">ğŸ“„ Condicionais</h5>
                        <div *ngFor="let d of tipoDocsCond" class="card mb-3">
                          <div class="flex justify-between items-center mb-2">
                            <span class="font-medium">{{ d.label }}</span>
                            <span *ngIf="uploading[d.key]" class="loading"></span>
                          </div>
                          <div class="flex gap-2 items-center">
                            <input type="file" (change)="onEscolherArquivo(d.key, $event)" accept=".pdf,.jpg,.jpeg,.png" class="form-input">
                            <button type="button" class="btn btn-sm btn-primary" (click)="enviarArquivo(d.key)" [disabled]="!arquivosSelecionados[d.key]">
                              ğŸ“¤ Anexar
                            </button>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Lista de Anexos -->
                    <div *ngIf="anexos?.length" class="table-container">
                      <table class="table">
                        <thead>
                          <tr>
                            <th>Nome</th>
                            <th>Tamanho</th>
                            <th>Enviado em</th>
                            <th>AÃ§Ãµes</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr *ngFor="let a of anexos">
                            <td>{{ a.nome_original }}</td>
                            <td>{{ a.tamanho_bytes | number }} bytes</td>
                            <td>{{ a.criado_em | date:'short' }}</td>
                            <td>
                              <div class="flex gap-2">
                                <button type="button" class="btn btn-sm btn-secondary" (click)="baixar(a)">
                                  ğŸ“¥ Baixar
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" (click)="excluir(a)" *ngIf="podeAnexar">
                                  ğŸ—‘ï¸ Excluir
                                </button>
                              </div>
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                    
                    <div *ngIf="!anexos?.length" class="text-center p-8">
                      <div class="text-4xl mb-2">ğŸ“</div>
                      <p class="text-muted">Nenhum anexo enviado ainda.</p>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>

    <div *ngIf="!carregandoLista && !meusAE?.length" class="text-center p-8">
      <div class="text-4xl mb-4">ğŸ“‹</div>
      <h3 class="mb-2">Nenhuma solicitaÃ§Ã£o encontrada</h3>
      <p class="text-muted mb-4">VocÃª ainda nÃ£o tem solicitaÃ§Ãµes de Nada Opor.</p>
      <button type="button" class="btn btn-primary btn-lg" (click)="abrirFormAE = true">
        ğŸ“ Fazer Primeira SolicitaÃ§Ã£o
      </button>
    </div>
  </section>

  <!-- Lista: Palestras -->
  <section *ngIf="tab==='PL'">
    <div *ngIf="minhasPL?.length" class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>Protocolo</th>
            <th>OrganizaÃ§Ã£o</th>
            <th>Cidade/UF</th>
            <th>Temas</th>
            <th>Status</th>
            <th>Criado</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let it of minhasPL">
            <td><strong>{{ it.protocolo }}</strong></td>
            <td>{{ it.organizacao || 'â€”' }}</td>
            <td>{{ it.cidade }} / {{ it.estado }}</td>
            <td>{{ it.temas }}</td>
            <td>
              <span class="badge badge-{{ it.status.toLowerCase().replace('_', '-') }}">
                {{ it.status }}
              </span>
            </td>
            <td>{{ it.criado_em | date:'short' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    
    <div *ngIf="!minhasPL?.length" class="text-center p-8">
      <div class="text-4xl mb-4">ğŸ¤</div>
      <h3 class="mb-2">Nenhuma solicitaÃ§Ã£o encontrada</h3>
      <p class="text-muted mb-4">VocÃª ainda nÃ£o tem solicitaÃ§Ãµes de Palestras.</p>
      <button type="button" class="btn btn-primary btn-lg" (click)="abrirFormPL = true">
        ğŸ“ Fazer Primeira SolicitaÃ§Ã£o
      </button>
    </div>
  </section>
</div>
